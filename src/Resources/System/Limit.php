<?php
namespace DreamFactory\Core\Limit\Resources\System;


use DreamFactory\Core\Resources\System\BaseSystemResource;
use DreamFactory\Core\Limit\Models\Limit as LimitsModel;
use DreamFactory\Library\Utility\Enums\DateTimeIntervals;
use DreamFactory\Core\Utility\ResourcesWrapper;
use DreamFactory\Core\Utility\ServiceRequest;
use DreamFactory\Core\Exceptions\BadRequestException;
use DreamFactory\Core\Models\Role;
use DreamFactory\Core\Models\User;
use DreamFactory\Core\Models\Service;


use Log;
use ServiceManager;

class Limit extends BaseSystemResource
{
    /**
     * @var string DreamFactory\Core\Models\BaseSystemModel Model Class name.
     */
    protected static $model = LimitsModel::class;

    protected $periods = [
        'Minute'  => DateTimeIntervals::MINUTES_PER_MINUTE,
        'Hour'    => DateTimeIntervals::MINUTES_PER_HOUR,
        'Day'     => DateTimeIntervals::MINUTES_PER_DAY,
        '7 Days'  => DateTimeIntervals::MINUTES_PER_WEEK,
        '30 Days' => DateTimeIntervals::MINUTES_PER_MONTH,
    ];


    /**
     * {@inheritdoc}
     */
    protected function handleGET()
    {
        $response = parent::handleGET(); // TODO: Change the autogenerated stub
        foreach($response['resource'] as &$limit){
            if(isset(LimitsModel::$limitPeriods[$limit['period_nbr']])){
                $limit['limit_period'] = LimitsModel::$limitPeriods[$limit['period_nbr']];
            }
            unset($limit['period_nbr']);
        }

        return $response;


    }

    /**
     * {@inheritdoc}
     */
    protected function handlePOST()
    {

        try {
            $this->enrichRecordData();
            return parent::handlePOST();

        } catch (\Exception $e){
            $message = $e->getMessage();
            if(preg_match('/Duplicate entry (.*) for key \'limit_key_hash\'/', $message)){
                throw new BadRequestException('A limit already exists with those parameters. No records added.', 0, $e);
            }
            throw new BadRequestException('An error occurred when inserting Limits: ' . $message);
        }

    }


    /**
     * {@inheritdoc}
     */
    protected function handlePATCH()
    {
        try {
            $this->enrichRecordData();
            return parent::handlePATCH();

        } catch (\Exception $e){
            $message = $e->getMessage();
            if(preg_match('/Duplicate entry (.*) for key \'limit_key_hash\'/', $message)){
                throw new BadRequestException('A limit already exists with those parameters. No records added.', 0, $e);
            }
            throw new BadRequestException('An error occurred when inserting Limits: ' . $message);
        }
    }


    protected function enrichRecordData()
    {
        $records = ResourcesWrapper::unwrapResources($this->getPayloadData());
        $limit = new static::$model;

        foreach($records as &$record){
            $limit_period_nbr = array_search($record['limit_period'], LimitsModel::$limitPeriods);
            if($this->validateLimitPayload($record)){
                $key = $limit->resolveCheckKey($record['limit_type'], $record['user_id'], $record['role_id'], $record['service_id'], $limit_period_nbr);
                $keyHash = sha1($key);
                $record['limit_key_text'] = $key;
                $record['limit_key_hash'] = $keyHash;
           }
        }

        $this->request->setPayloadData(ResourcesWrapper::wrapResources($records));

        /* For bulk create, rollback the transaction if a record fails. */
        $this->request->setParameter('rollback', true);
    }



    protected function validateLimitPayload(&$record){

        /* Default service id enriched value - will get set from name if exists in database in _resolveServiceName(). */
        $record['service_id'] = null;

        switch ($record['limit_type']) {
            case 'instance':
            case 'instance.each_user':
                break;

            case 'instance.user':

                if( ! isset($record['user_id']) || is_null($record['user_id'])){
                    throw new BadRequestException('user_id must be specified with this limit type. Limit: ' . $record['label_text']);
                }

                if( ! $this->_checkUser($record['user_id'])){
                    throw new BadRequestException('user_id does not exist for ' . $record['label_text'] . ' limit.');
                }

                break;

            case 'instance.role':

                if( ! isset($record['role_id']) || is_null($record['role_id'])){
                    throw new BadRequestException('role_id must be specified with this limit type. Limit: ' . $record['label_text']);
                }

                if( ! $this->_checkRole($record['role_id'])){
                    throw new BadRequestException('No role_id exists for ' . $record['label_text'] . ' limit.');
                }

                break;

            case 'instance.user.service':

                if( ! isset($record['user_id']) || is_null($record['user_id'])){
                    throw new BadRequestException('user_id must be specified with this limit type. Limit: ' . $record['label_text']);
                }

                if( ! $this->_checkUser($record['user_id'])){
                    throw new BadRequestException('No user_id exists for ' . $record['label_text'] . ' limit.');
                }

                if( ! isset($record['service_name']) || is_null($record['service_name'])){
                    throw new BadRequestException('service_name must be specified with this limit type. Limit: ' . $record['label_text']);
                }

                if( ! $this->_resolveServiceName($record)){
                    throw new BadRequestException('No service_name exists for ' . $record['label_text'] . ' limit.');
                }

                break;

            case 'instance.each_user.service':

                if( ! isset($record['service_name']) || is_null($record['service_name'])){
                    throw new BadRequestException('service_name must be specified with this limit type.');
                }
                if( ! $this->_resolveServiceName($record)){
                    throw new BadRequestException('No service_name exists for ' . $record['label_text'] . ' limit.');
                }

                break;

            case 'instance.service':

                if( ! isset($record['service_name']) || is_null($record['service_name'])){
                    throw new BadRequestException('service_name must be specified with this limit type.');
                }

                if( ! $this->_resolveServiceName($record)){
                    throw new BadRequestException('No service_name exists for ' . $record['label_text'] . ' limit.');
                }

                break;
        }
        return true;
    }

    protected function _checkUser($id){
        return User::where('id', $id)->count();
    }

    protected function _checkRole($id){
        return Role::where('id', $id)->count();
    }

    protected function _resolveServiceName(&$record){

        if($service = Service::where('name', $record['service_name'])->first()){
            $record['service_id'] = $service->id;
            return true;
        }
        return false;
    }


}